[![Go Report Card](https://goreportcard.com/badge/github.com/bfix/bb_relay)](https://goreportcard.com/report/github.com/bfix/bb_relay)
[![GoDoc](https://godoc.org/github.com/bfix/bb_relay?status.svg)](https://godoc.org/github.com/bfix/bb_relay)

# Bitbank - Relay (bb_relay)

(c) 2021 Bernd Fix <brf@hoi-polloi.org>   >Y<

bb_relay is free software: you can redistribute it and/or modify it
under the terms of the GNU Affero General Public License as published
by the Free Software Foundation, either version 3 of the License,
or (at your option) any later version.

bb_relay is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.

SPDX-License-Identifier: AGPL3.0-or-later

# Introduction

The `bb_relay` software enables individuals and small organizations to accept
cryptocurrencies (Bitcoin, Ethereum and ten other Altcoins) on their webpage.

To manage the received coins it is highly recommended to use a multi-coin
HD wallet with optional [Trezor support](https://trezor.io).

# Build (optional)

If you want to build the software yourself, you need `Go v1.16+` that can be
[downloaded here](https://golang.org/dl/). Make sure you setup Go-related
environment variables as described in the Go documentation.

After you have cloned the repository to your local machine (and every time
you pull a newer version), you should update the dependencies for `bb_relay`:

```bash
go mod tidy
```

To build the three components (configurator, db and web):

```bash
cd configurator
go build
cd ../db
go build
cd ../web
go build
cd ..
```

# Configuration

You need to configure/setup the `bb_relay` package in parallel with the
multi-coin HD wallet you want to use to manage incoming crypto funds. You can
either do this semi-automatically or manually.

Change into the `configurator/` folder. The configuration will be stored in a
file named `config.json`; copy this generated or edited `config.json` file to
the `db/` and `web/` folders for later use.

## Semi-automatic configuration

This assumes that you are going to setup a new multi-coin HD wallet / Trezor
device. This is the standard procedure for most setups.

### Generate new HD wallet data

As a security measure it is recommended to run this step on an air-gapped
computer or at least in a safe environment (e.g. in a secure system like
[Tails](https://tails.boum.org)). Just copy the `configurator` executable
and the `config-template.json` file to the system; the configurator program
will use the `config-template.json` file and generates a new `config.json`
file you need to deploy later on. Run the configurator:

```bash
./configurator | tee config.log
```

First you will be asked for a passphrase; make sure you use a long and safe
input. Do not reuse existing passphrases, but create a new one especially
for this purpose.

The program will output information to the console; the above command captures
the output to a file `config.log` that can be printed for safe-keeping. Anyone
with access to this information will be able to make transactions! Make sure
you delete the file after printing.

### Initialize HD wallet / Trezor device

Part of the printed information (`config.log`) are the 24 seed words used to
setup a HD wallet or Trezor device.

After setting up the wallet you should check the addresses listed in
`config.log` for all cryptocurrencies to match the addresses generated by the
wallet. Please check at lease two addresses per coin to make sure the setup
worked correctly.

## Manual configuration

If you have an existing HD wallet / Trezor device you want to use without a
full reset with new keys, you can manually setup the `config.json` file - but
it is a time-consuming task.

Copy the `config-template.json` to a new `config.json` and open the new file
in an editor. You need to fill in data for the `pk` and `addr` fields in all
entries in the `coins` section:

```json
"coins": [
    {
        "symb": "btc",
        "path": "m/49'/0'/0'",
        "mode": "P2SH",
        "pk": "",
        "addr": ""
    },

```

Use the wallet UI to extract the `xpub` key for an account and insert the
result in the `pk` field. Also put the first address of an account into
the `addr` field.

### Using a Trezor device

You can use the `trezorctl` utility to generate the required information
from an initialized Trezor device.

**Example**: Generate the info for Bitcoin (`btc`) by running the
following commands:

```bash
trezorctl get-public-node -t p2shsegwit -n "m/49'/0'/0'"
```

The value for `pk` is returned in the line starting with "xpub:"

```bash
trezorctl get-address -t p2shsegwit -n "m/49'/0'/0'/0/0"
```

The command prints the value for `addr`.

# Deployment

The deployment for `bb_relay` includes:

* `web` executable (from the `web/` folder)
* `config.json` (the genrated/edited configuration file)
* an initialized relay database (MySQL or SQLite3)

## Relay database

The `config.json` specifies which database engine to use and how to access it.

* For a MySQL database:

```json
"database": {
    "mode": "mysql",
    "connect": "bb_relay:bb_relay@tcp(127.0.0.1:3306)/BB_Relay"
},
```

* For a SQLite3 database:

```json
"database": {
    "mode": "sqlite3",
    "connect": "relay.db"
},
```

Either database is initialized with a SQL script found in the `db/` folder:

* `db_create.mysql.sql` for MySQL database engine (adjust to your local env)
* `fb_create.sqlite3.sql` for SQLite3 database file (add to deployment)

### Initialize database

You need to initialize the database with information about the accepted coins
and the accounts you want to support. Each account has one or more
crypto-currencies assigned to it; these are the coins that will be accepted
for an account.

```sql
-- create list of supported coins
insert into coin(symbol,label) values
    ('btc',  'Bitcoin'),
    ('ltc',  'Litecoin'),
    ('doge', 'Dogecoin'),
    ('dash', 'Dash'),
    ('nmc',  'Namecoin'),
    ('dgb',  'Digibyte'),
    ('vtc',  'Vertcoin'),
    ('eth',  'Ethereum'),
    ('etc',  'Ethereum Classic'),
    ('zec',  'ZCash'),
    ('bch',  'Bitcoin Cash'),
    ('btg',  'Bitcoin Gold');

insert into account(label) values
    ("Account #1"), ("Account #2");

insert into accept(coin,accnt) values
    (1, 1), (11, 1), (12, 1), ...;
```

To add the coin logos to the database, change into the `db/` folder and run:

```bash
./db logo import -i images
```

# Testing

(to be described)
